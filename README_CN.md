# RadioTalk - ESP32 双模式无线电设备

<div align="center">

  ![PlatformIO](https://img.shields.io/badge/PlatformIO-ESP32%20Dev-blue)
  ![License](https://img.shields.io/badge/license-MIT-green)
  ![Status](https://img.shields.io/badge/status-stable-success)

  一款结合 FM 收音机接收和双工无线电收发器功能的 ESP32 便携式无线电设备。

  [功能特性](#功能特性) • [硬件配置](#硬件配置) • [编译说明](#编译说明) • [使用指南](#使用指南) • [安全警告](#安全警告)

</div>

---

## 项目简介

本项目是一个基于 ESP32 的便携式无线电设备，支持：

- **FM 收音机接收** (87-108 MHz) 通过 RDA5807 芯片
- **双工无线电收发** (VHF/UHF/WHF 频段) 通过 A1846S 芯片
- **TFT LCD 显示屏** 实时显示频率和信号强度
- **旋转编码器** 精确调节频率/音量
- **电池监控** 自动校准电量

---

## 功能特性

### 无线电模式

| 模式 | 芯片 | 频率范围 | 预设频道 |
|------|------|-----------------|----------|
| FM 收音机 | RDA5807 | 87-108 MHz | 20 个预设 |
| 双工（发射） | A1846S | 134-520 MHz | 20 个预设 |
| 双工（接收） | A1846S | 134-520 MHz | 20 个预设 |

### 用户界面

- **TFT LCD 显示屏** (ST7789/GC9307)
  - 频率显示（6 频道视图）
  - 信号强度表（S 表）
  - 电池电量指示
  - 音量指示
  - 立体声/RX/TX 模式指示

- **旋转编码器** (34/39 引脚)
  - 频率调节（可配置步进：10/25/50/100/200/1000 kHz）
  - 音量调节（0-15）

- **按键功能**
  - **上按钮** - 模式切换、频道选择、音量模式
  - **中按钮** - 频道导航、频率保存/删除、频段切换
  - **下按钮** - 启用发射、模式切换、频道导航
  - **编码器按钮** - 步进大小循环、搜台模式、关机

### 安全功能

- 看门狗定时器（30 秒超时）防止系统死机
- RF 功率限制（安全发射功率等级）
- 发射前频率范围验证
- I2C 错误处理和自动重试
- 电池过放保护

---

## 硬件配置

### 组件清单

| 组件 | 说明 |
|-----------|-------------|
| 主控 | ESP32-WROOM |
| FM 收音机 | RDA5807 |
| 双工无线电 | A1846S |
| 显示屏 | ST7789/GC9307 TFT LCD (320x170) |
| 旋转编码器 | EC11 |
| 电池 | 18650 锂电池 |

### 引脚映射

| 功能 | 引脚 | 备注 |
|----------|-----|-------|
| 中按钮 (SW1) | GPIO 32 | 按键 |
| 下按钮 (SW2) | GPIO 35 | 按键 |
| 上按钮 (SW3) | GPIO 16 | 按键 |
| 编码器按键 (Push) | GPIO 36 | 编码器按钮 |
| 编码器 A (RE_PIN1) | GPIO 34 | 编码器 A 相 |
| 编码器 B (RE_PIN2) | GPIO 39 | 编码器 B 相 |
| 电池检测 (ADC) | GPIO 25 | 电池电压 |
| 屏幕背光 (LCD_BLK) | GPIO 4 | LCD 背光 |
| 屏幕片选 (LCD_CS) | GPIO 15 | LCD 片选 |
| 功放控制 (AMP_PIN) | GPIO 33 | 放大器控制 |
| 1846 电源 (EN_1846) | GPIO 26 | A1846S 电源 |
| 5807 电源 (EN_5807) | GPIO 27 | RDA5807 电源 |
| 主控电源 (PWR_ON) | GPIO 12 | MCU 电源控制 |
| 1846 片选 (SENB) | GPIO 17 | A1846S 片选 |
| I2C SDA | GPIO 21 | I2C 数据线 |
| I2C SCL | GPIO 22 | I2C 时钟线 |

### 系统框图

```
┌─────────────────────────────────────────────────────────┐
│                      ESP32-WROOM                        │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │  RDA5807   │  │  A1846S    │  │ ST7789     │       │
│  │  (FM收音机)│  │(双工收发器) │  │  (LCD屏)   │       │
│  └────────────┘  └────────────┘  └────────────┘       │
│         │               │               │               │
│         └───────────────┴───────────────┘               │
│                    I2C 总线                              │
└─────────────────────────────────────────────────────────┘
         │                    │
    ┌────┴────┐         ┌────┴────┐
    │  EC11   │         │ 18650   │
    │ 旋码器  │         │ 电池组  │
    └─────────┘         └─────────┘
```

---

## 编译说明

### 环境要求

- [PlatformIO](https://platformio.org/) VSCode 扩展
- ESP32 开发板
- USB 编程线

### 编译命令

```bash
# 编译项目
platformio run

# 上传到 ESP32
platformio run --target upload

# 监控串口输出 (115200 波特率)
platformio device monitor -b 115200

# 一键编译、上传和监控
platformio run --target upload && platformio device monitor -b 115200
```

### 依赖库

依赖库会由 PlatformIO 自动安装：

- `HamShield` - A1846S 收发器控制
- `RDA5807` - FM 收音机接收器控制
- `TFT_eSPI` - 显示屏驱动
- `OneButton` - 按键防抖和多击检测
- `RotaryEncoder` - 旋转编码器输入处理
- `Battery18650Stats` - 电池电量监控

---

## 使用指南

### 按键操作说明

| 按键 | 操作 | 功能 |
|--------|--------|----------|
| **上键（单击）** | 单击 | 跳转到预设频道 |
| **上键（双击）** | 双击 | 进入音量调节模式 |
| **上键（长按）** | 长按 | 在 FM 收音机和双工模式间切换 |
| **上键（5次点击）** | 连点5次 | 校准频率偏移 |
| **中键（单击）** | 单击 | 上一个频道 |
| **中键（双击）** | 双击 | 删除预设 / 切换频段 |
| **中键（长按）** | 长按 | 保存当前频率到预设 |
| **下键（按住）** | 按住 | 启用发射（仅 TX 模式） |
| **下键（单击）** | 单击 | 下一个频道 / 进入接收模式 |
| **下键（双击）** | 双击 | 切换 TX/RX 模式 |
| **编码器（单击）** | 单击 | 循环切换步进大小 |
| **编码器（双击）** | 双击 | 进入搜台模式 |
| **编码器（长按）** | 长按 | 关机 |

### 显示界面说明

```
┌─────────────────────────────────────────────────────────┐
│  FM 收音机                  409.800 MHz      步进:100KHz │
│  ┌──────────┐                                          │
│  │ 频道列表 │  ● 频道0: 409.750                          │
│  │          │  ○ 频道1: 409.762                          │
│  │          │  ○ 频道2: 409.775                          │
│  │          │  ○ 频道3: 409.787                          │
│  │          │  ○ 频道4: 409.800                          │
│  │          │  ○ 频道5: 409.812                          │
│  └──────────┘                                          │
│                               信号: ████████ 80%       │
│       模式: 接收              音量: ● 10    电池: 85%   │
│                                                            │
│  ────────────────────────────────────────────────────── │
│  │     409.750    409.760    409.770    409.780      │
└─────────────────────────────────────────────────────────┘
```

### 频率频段说明

| 频段 | 范围 | 备注 |
|------|-------|-------|
| WHF | 134-174 MHz | 气象频段 |
| VHF | 200-260 MHz | VHF 民用频段 |
| UHF | 400-520 MHz | UHF 民用频段（默认） |

---

## 安全警告

<div align="center">

### ⚠️ 法规合规声明 ⚠️

**本项目仅供学习使用。**

</div>

- **切勿在未经授权的频率上发射**
- **切勿在可能干扰应急通信的区域使用此设备**
- **切勿在未连接天线的情况下发射**
- **始终遵守当地无线电法规**

### 重要安全提示

1. **频率合规**：预设频道（409.750-409.987 MHz）仅作示例。使用前请核实您所在地区的合法频率。

2. **RF 暴露**：长时间暴露于 RF 能量可能有害。发射期间请与天线保持安全距离。

3. **天线要求**：**切勿在未连接匹配天线的情况下发射**。这会损坏射频功率放大器。

4. **功率限制**：固件将 TX 功率限制在等级 10（共 15 级）以确保安全。在充分了解 RF 安全之前，请勿修改此设置。

5. **法律责任**：用户有责任确保遵守所有适用法律法规。

---

## 故障排除

### 设备无法开机
- 检查电池电压（应 >3.3V）
- 验证 PWR_ON 引脚 (GPIO 12) 在启动期间未被拉低（启动引脚）
- 尝试先通过 USB 编程

### 无音频输出
- 检查 AMP_PIN (GPIO 33) 是否为高电平
- 确认音量未静音（VOL > 0）
- 检查扬声器连接

### RF 发射不工作
- 确保处于 TX 模式（双击下按钮）
- 验证频率在有效范围内
- 检查天线已连接
- 验证频率偏移校准

### 显示屏不工作
- 检查 LCD_BLK 引脚 (GPIO 4) 为高电平以开启背光
- 验证 LCD_CS 引脚 (GPIO 15) 连接
- 尝试修改代码中的旋转角度（第 131 行：`tft.setRotation(3)`）

### A1846S 初始化失败
- 检查 I2C 连接 (SDA=21, SCL=22)
- 验证 SENB 引脚 (GPIO 17)
- 检查 EN_1846 (GPIO 26) 的电源
- 串口监视器会显示重试尝试

---

## 项目结构

```
├── src/
│   └── esp32txshaoluceshichengg.ino    # 主程序
├── lib/
│   ├── HamShield/                       # A1846S 库
│   ├── RDA5807/                         # FM 收音机库
│   └── ...
├── platformio.ini                        # 编译配置
├── CLAUDE.md                            # 项目文档
└── README.md                            # 英文说明
```

---

## 技术规格

| 规格 | 数值 |
|---------------|-------|
| 供电电压 | 3.7V (18650 电池) |
| 工作电流 | ~100mA (接收), ~500mA (发射) |
| RF 输出功率 | ~500mW (等级 10) |
| 频率稳定度 | ±2.5ppm |
| 音频输出 | 1W @ 8Ω |
| 显示分辨率 | 320x170 像素 |
| 电池续航 | ~4 小时 (发射), ~12 小时 (接收) |

---

## 贡献

欢迎贡献！请随时提交 Pull Request。

1. Fork 本项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

---

## 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件。

---

## 致谢

- [HamShield](https://github.com/Whensomebodylovesyou/HamShield) - A1846S 库
- [RDA5807](https://github.com/peakcreative/RDA5807) - FM 收音机库
- [TFT_eSPI](https://github.com/Bodmer/TFT_eSPI) - 显示屏库
- [OneButton](https://github.com/mathertel/OneButton) - 按键库
- [RotaryEncoder](https://github.com/mathertel/RotaryEncoder) - 编码器库

---

## 作者

**todaynews520**

- GitHub: [@todaynews520](https://github.com/todaynews520)

---

<div align="center">

  **⚠️ 请合法、合规使用 ⚠️**

  为无线电爱好者制作

  [返回顶部](#radiotalk---esp32-双模式无线电设备)

</div>
